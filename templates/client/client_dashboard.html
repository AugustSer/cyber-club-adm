<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–µ—Ä–º–∏–Ω–∞–ª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f8f9fa;
        }
        .header-card {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border-radius: 15px;
            margin-bottom: 2rem;
        }
        .info-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 1rem;
        }
        .balance-card {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }
        .computer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .computer-card {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .computer-card.available {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        .computer-card.available:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .computer-card.occupied {
            border-color: #dc3545;
            background-color: #fff8f8;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .btn-book {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="header-card p-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="mb-1">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ client.name }}!</h2>
                    <p class="mb-0">ID: {{ client.id }} | –¢–µ–ª–µ—Ñ–æ–Ω: {{ client.phone }}</p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/logout" class="btn btn-light">–í—ã–π—Ç–∏</a>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –ë–∞–ª–∞–Ω—Å -->
            <div class="col-md-4">
                <div class="card info-card balance-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å</h5>
                        <h3 class="mb-0">{{ "%.2f"|format(client.balance) }} ‚ÇΩ</h3>
                        {% if client.balance < 100 %}
                        <small class="text-warning">‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</small>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="col-md-4">
                <div class="card info-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                        <p class="mb-1">–í—Å–µ–≥–æ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ: {{ "%.2f"|format(client.total_spent) }} ‚ÇΩ</p>
                        <p class="mb-0">–ê–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–µ–π: {{ client.active_bookings|length }}</p>
                    </div>
                </div>
            </div>

            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="col-md-4">
                <div class="card info-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                        <p class="mb-1">–í—Ä–µ–º—è: <span id="currentTime"></span></p>
                        <p class="mb-0">–î–æ—Å—Ç—É–ø–Ω–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤: {{ client.available_computers|length }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        {% if client.active_bookings %}
        <div class="card info-card">
            <div class="card-header">
                <h5 class="mb-0">üéÆ –í–∞—à–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏</h5>
            </div>
            <div class="card-body">
                {% for booking in client.active_bookings %}
                <div class="alert alert-info">
                    <strong>{{ booking.computer_name }}</strong><br>
                    –ù–∞—á–∞–ª–æ: {{ booking.start_time }}<br>
                    {% if booking.end_time %}
                    –û–∫–æ–Ω—á–∞–Ω–∏–µ: {{ booking.end_time }}
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã -->
        <div class="card info-card">
            <div class="card-header">
                <h5 class="mb-0">üíª –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h5>
            </div>
            <div class="card-body">
                {% if client.available_computers %}
                <div class="computer-grid">
                    {% for computer in client.available_computers %}
                    <div class="computer-card available" onclick="selectComputer({{ computer.id }}, '{{ computer.name }}', {{ computer.hourly_rate }})">
                        <h6>{{ computer.name }}</h6>
                        <p class="mb-2">{{ computer.hourly_rate }} ‚ÇΩ/—á–∞—Å</p>
                        <button type="button" class="btn btn-book btn-sm">
                            –í—ã–±—Ä–∞—Ç—å
                        </button>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <h5 class="text-muted">–í—Å–µ –∫–æ–º–ø—å—é—Ç–µ—Ä—ã –∑–∞–Ω—è—Ç—ã</h5>
                    <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
        <div class="card info-card">
            <div class="card-header">
                <h5 class="mb-0">üìã –ö–∞–∫ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</h5>
            </div>
            <div class="card-body">
                <ol>
                    <li>–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ</li>
                    <li>–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∏–≥—Ä—ã (–±—É–¥–µ—Ç —Å–ø–∏—Å–∞–Ω–æ —Å –±–∞–ª–∞–Ω—Å–∞)</li>
                    <li>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                    <li>–ü–æ–¥–æ–π–¥–∏—Ç–µ –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∫–æ–º–ø—å—é—Ç–µ—Ä—É –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É</li>
                </ol>
                <div class="alert alert-warning">
                    <strong>–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ:</strong> –°—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.
                    –ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å, –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div class="modal fade" id="bookingModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="/book_computer">
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <strong>–ö–æ–º–ø—å—é—Ç–µ—Ä: <span id="selectedComputerName"></span></strong><br>
                            <strong>–¢–∞—Ä–∏—Ñ: <span id="selectedComputerRate"></span> ‚ÇΩ/—á–∞—Å</strong><br>
                            <strong>–í–∞—à –±–∞–ª–∞–Ω—Å: {{ "%.2f"|format(client.balance) }} ‚ÇΩ</strong>
                        </div>

                        <input type="hidden" id="selectedComputerId" name="computer_id">

                        <div class="mb-3">
                            <label for="duration" class="form-label">–í—Ä–µ–º—è –∏–≥—Ä—ã</label>
                            <select class="form-select" id="duration" name="duration_hours" required>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</option>
                                <option value="0.5">30 –º–∏–Ω—É—Ç</option>
                                <option value="1">1 —á–∞—Å</option>
                                <option value="1.5">1.5 —á–∞—Å–∞</option>
                                <option value="2">2 —á–∞—Å–∞</option>
                                <option value="3">3 —á–∞—Å–∞</option>
                                <option value="4">4 —á–∞—Å–∞</option>
                                <option value="6">6 —á–∞—Å–æ–≤</option>
                            </select>
                        </div>

                        <div class="alert alert-warning" id="costAlert" style="display: none;">
                            <strong>–ö –æ–ø–ª–∞—Ç–µ: <span id="totalCost">0</span> ‚ÇΩ</strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-success" id="confirmBooking" disabled>
                            –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="position-fixed top-0 end-0 p-3" style="z-index: 1055">
                {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedRate = 0;
        const clientBalance = {{ client.balance }};

        function selectComputer(computerId, computerName, hourlyRate) {
            document.getElementById('selectedComputerId').value = computerId;
            document.getElementById('selectedComputerName').textContent = computerName;
            document.getElementById('selectedComputerRate').textContent = hourlyRate;
            selectedRate = hourlyRate;

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('duration').value = '';
            document.getElementById('costAlert').style.display = 'none';
            document.getElementById('confirmBooking').disabled = true;

            new bootstrap.Modal(document.getElementById('bookingModal')).show();
        }

        document.getElementById('duration').addEventListener('change', function() {
            const duration = parseFloat(this.value);
            if (duration && selectedRate) {
                const totalCost = duration * selectedRate;
                document.getElementById('totalCost').textContent = totalCost.toFixed(2);
                document.getElementById('costAlert').style.display = 'block';

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ—Å—Ç—å –±–∞–ª–∞–Ω—Å–∞
                if (totalCost <= clientBalance) {
                    document.getElementById('confirmBooking').disabled = false;
                    document.getElementById('costAlert').className = 'alert alert-success';
                } else {
                    document.getElementById('confirmBooking').disabled = true;
                    document.getElementById('costAlert').className = 'alert alert-danger';
                    document.getElementById('costAlert').innerHTML =
                        '<strong>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!</strong><br>' +
                        '–ö –æ–ø–ª–∞—Ç–µ: ' + totalCost.toFixed(2) + ' ‚ÇΩ<br>' +
                        '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞';
                }
            }
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ru-RU');
        }

        updateTime();
        setInterval(updateTime, 1000);

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
        setTimeout(function() {
            window.location.reload();
        }, 120000);
    </script>
</body>
</html>