

<!DOCTYPE html>

{% extends "base.html" %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç—á–µ—Ç—ã - –ê–†–ú –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .report-card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            margin-bottom: 2rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }
        .table-responsive {
            border-radius: 8px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/admin">–ê–†–ú –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/admin">–î–∞—à–±–æ—Ä–¥</a>
                <a class="nav-link" href="/admin/clients">–ö–ª–∏–µ–Ω—Ç—ã</a>
                <a class="nav-link" href="/admin/computers">–ö–æ–º–ø—å—é—Ç–µ—Ä—ã</a>
                <a class="nav-link active" href="/admin/reports">–û—Ç—á–µ—Ç—ã</a>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-12">
                <h2>–û—Ç—á–µ—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                <p class="text-muted">–î–∞–Ω–Ω—ã–µ –∑–∞ {{ "—Å–µ–≥–æ–¥–Ω—è (%s)"|format(datetime.now().strftime('%d.%m.%Y')) }}</p>
            </div>
        </div>
        <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid">
            <div class="stat-card">
                <h5>–°–µ—Å—Å–∏–π —Å–µ–≥–æ–¥–Ω—è</h5>
                <h3>{{ today_sessions|length }}</h3>
            </div>
            <div class="stat-card">
                <h5>–í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h5>
                <h3>{{ "%.2f"|format(week_revenue[-1].revenue if week_revenue else 0) }} ‚ÇΩ</h3>
            </div>
            <div class="stat-card">
                <h5>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</h5>
                <h3>{{ today_sessions|map(attribute='client_id')|unique|list|length }}</h3>
            </div>
            <div class="stat-card">
                <h5>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–æ–≤</h5>
                <h3>{{ "%.1f"|format((computer_stats|length / 20 * 100) if computer_stats else 0) }}%</h3>
            </div>
        </div>
        <div class="row">
            <!-- –ì—Ä–∞—Ñ–∏–∫ –≤—ã—Ä—É—á–∫–∏ –∑–∞ –Ω–µ–¥–µ–ª—é -->
            <div class="col-md-6">
                <div class="card report-card">
                    <div class="card-header">
                        <h5 class="mb-0">üí∞ –í—ã—Ä—É—á–∫–∞ –∑–∞ –Ω–µ–¥–µ–ª—é</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row g-4">
        <div class="col-lg-8">
            <div class="card-custom">
                <div class="card-body">
                    <h5 class="mb-4">
                        <i class="fas fa-doughnut-bite me-2"></i>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                    </h5>
                    <canvas id="timeDistributionChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-custom">
                <div class="card-body">
                    <h5 class="mb-4">
                        <i class="fas fa-clock me-2"></i>–ü–∏–∫–æ–≤—ã–µ —á–∞—Å—ã
                    </h5>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>14:00 - 16:00</span>
                            <strong class="text-primary">–í—ã—Å–æ–∫–∞—è</strong>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-primary" style="width: 85%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>18:00 - 20:00</span>
                            <strong class="text-success">–°—Ä–µ–¥–Ω—è—è</strong>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: 65%"></div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>10:00 - 12:00</span>
                            <strong class="text-warning">–ù–∏–∑–∫–∞—è</strong>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-warning" style="width: 35%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>

{% block extra_scripts %}
<script>
// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = weekAgo.toISOString().split('T')[0];

    initializeCharts();
});

function initializeCharts() {
    // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    const revenueData = [
        {% for day in daily_revenue %}
        {{ day[1] }},
        {% endfor %}
    ];
    const revenueLabels = [
        {% for day in daily_revenue %}
        '{{ day[0] }}',
        {% endfor %}
    ];

    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: revenueLabels,
            datasets: [{
                label: '–î–æ—Ö–æ–¥ (‚ÇΩ)',
                data: revenueData,
                borderColor: 'hsl(217, 91%, 60%)',
                backgroundColor: 'hsla(217, 91%, 60%, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: 'hsl(210, 11%, 98%)'
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: 'hsl(210, 11%, 70%)'
                    },
                    grid: {
                        color: 'hsl(210, 11%, 25%)'
                    }
                },
                y: {
                    ticks: {
                        color: 'hsl(210, 11%, 70%)',
                        callback: function(value) {
                            return value + ' ‚ÇΩ';
                        }
                    },
                    grid: {
                        color: 'hsl(210, 11%, 25%)'
                    }
                }
            }
        }
    });

    // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    const timeCtx = document.getElementById('timeDistributionChart').getContext('2d');
    new Chart(timeCtx, {
        type: 'doughnut',
        data: {
            labels: ['–£—Ç—Ä–æ (9-12)', '–î–µ–Ω—å (12-18)', '–í–µ—á–µ—Ä (18-22)', '–ù–æ—á—å (22-9)'],
            datasets: [{
                data: [15, 45, 30, 10],
                backgroundColor: [
                    'hsl(45, 93%, 47%)',   // –∂–µ–ª—Ç—ã–π
                    'hsl(217, 91%, 60%)',  // —Å–∏–Ω–∏–π
                    'hsl(142, 76%, 36%)',  // –∑–µ–ª–µ–Ω—ã–π
                    'hsl(0, 84%, 60%)'     // –∫—Ä–∞—Å–Ω—ã–π
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: 'hsl(210, 11%, 98%)',
                        padding: 20
                    }
                }
            }
        }
    });
}

function updateReports() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    if (startDate && endDate) {
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        showNotification('–û—Ç—á–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–µ—Ä–∏–æ–¥–∞ ' + startDate + ' - ' + endDate, 'success');
    }
}

function exportReport(format) {
    showNotification('–≠–∫—Å–ø–æ—Ä—Ç –≤ ' + format.toUpperCase() + ' –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö', 'info');
}
</script>
{% endblock %}
